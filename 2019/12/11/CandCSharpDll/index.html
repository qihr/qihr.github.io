<!DOCTYPE html>












  


<html class="theme-next mist use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.1.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/myselficon.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/myselficon32.png?v=7.1.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/myselficon16.png?v=7.1.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.1.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Mist',
    version: '7.1.0',
    sidebar: {"position":"left","width":200,"display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: true,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="链接库可以解决在项目中需要调用其他语言代码（如C/C++）的需求。库中保存了其他程序需要调用的方法。 注：C++下导出链接库和使用方法和C有区别">
<meta name="keywords" content="CSharp,Unity,C,Android">
<meta property="og:type" content="article">
<meta property="og:title" content="Unity下C#调用纯C动态链接库">
<meta property="og:url" content="http://yoursite.com/2019/12/11/CandCSharpDll/index.html">
<meta property="og:site_name" content="Note">
<meta property="og:description" content="链接库可以解决在项目中需要调用其他语言代码（如C/C++）的需求。库中保存了其他程序需要调用的方法。 注：C++下导出链接库和使用方法和C有区别">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554868057.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554869322.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554869544.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555668421.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554870532.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554870620.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555056920.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555058072.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555058152.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555059881.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555061641.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555061782.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555062363.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555062503.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555065573.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555068565.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555295955.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555296277.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555296407.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555296521.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555297411.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555298228.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555153592.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555137646.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Honeycam%202019-04-13%2015-11-35.gif">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555140513.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555141665.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555141480.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555068534.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555136600.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555136869.png">
<meta property="og:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555136994.png">
<meta property="og:updated_time" content="2019-12-11T15:37:07.590Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Unity下C#调用纯C动态链接库">
<meta name="twitter:description" content="链接库可以解决在项目中需要调用其他语言代码（如C/C++）的需求。库中保存了其他程序需要调用的方法。 注：C++下导出链接库和使用方法和C有区别">
<meta name="twitter:image" content="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554868057.png">





  
  
  <link rel="canonical" href="http://yoursite.com/2019/12/11/CandCSharpDll/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Unity下C#调用纯C动态链接库 | Note</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Note</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">How more than you show,speak less than you know.</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/12/11/CandCSharpDll/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Sayi">
      <meta itemprop="description" content="Just noob.">
      <meta itemprop="image" content="/images/myselelogin.png">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Note">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Unity下C#调用纯C动态链接库

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2019-12-11 23:37:07" itemprop="dateCreated datePublished" datetime="2019-12-11T23:37:07+08:00">2019-12-11</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/Program/" itemprop="url" rel="index"><span itemprop="name">Program</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">21k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">19 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>链接库可以解决在项目中需要调用其他语言代码（如C/C++）的需求。库中保存了其他程序需要调用的方法。</p>
<p>注：C++下导出链接库和使用方法和C有区别</p>
<a id="more"></a>
<h1 id="一-概述"><a href="#一-概述" class="headerlink" title="一 概述"></a>一 概述</h1><h2 id="1-1-动态与静态链接库"><a href="#1-1-动态与静态链接库" class="headerlink" title="1.1 动态与静态链接库"></a>1.1 动态与静态链接库</h2><p>链接库分<strong>动态链接库</strong>（Dynamic-link library，简写DLL）以及<strong>静态链接库</strong>（Statically-linked library）。</p>
<h3 id="区别"><a href="#区别" class="headerlink" title="区别"></a>区别</h3><p><strong>动态链接库：</strong>在程序编译时，动态库中的函数代码不复制到可执行文件中，待程序需要调用库中函数时再进行加载。</p>
<p><strong>静态链接库：程序编译时使用到的静态库会被打包到可执行文件中。</strong></p>
<p><strong>优势</strong>：</p>
<p>动态库只有在需要时才会加载，所以比静态库要节省内存，可扩展性强，同时减少了开发中的耦合度。</p>
<p>而静态库由于存在于执行文件中，所以代码的装载，执行速度要比动态库快。</p>
<p><strong>劣势：</strong></p>
<p>动态库的版本一旦出现异常，冲突，会引发DLL HELL问题。并且，动态库虽然节省内存，但调用方法的开销大，需要多次的间接访问才能调用到方法。</p>
<p>静态库生成的可执行文件体积较大，且代码无法共享。</p>
<h2 id="1-2-不同系统下的链接库格式"><a href="#1-2-不同系统下的链接库格式" class="headerlink" title="1.2 不同系统下的链接库格式"></a>1.2 不同系统下的链接库格式</h2><p><strong>Windows</strong>：.dll（动态库），.lib（静态库）</p>
<p><strong>Linux（以及基于Linux的Android）</strong>：.so(动态库，share object)，.a（静态库）</p>
<p><strong>Mac：</strong>.a、.framework（静态库），.tbd，.dylib，.framework（动态库）</p>
<p><em>注：在Mac（iOS）系统下包含动态库的应用程序<strong>无法在Apple Store通过审核上架</strong>。详情：IOS静态库和动态库</em></p>
<h2 id="1-3-P-Invoke"><a href="#1-3-P-Invoke" class="headerlink" title="1.3 P/Invoke"></a>1.3 P/Invoke</h2><blockquote>
<p>P/Invoke又名平台调用，是.NET CLR提供的，为了使开发者从托管代码(如题主的C#)调用动态连接库中的非托管代码（通常是C）而提供的一种服务。</p>
<p>在受控代码与非受控代码进行交互时会产生一个事务（transition） ，这通常发生在使用平台调用服务（Platform Invocation Services），即P/Invoke</p>
</blockquote>
<p>简单来说，就是P/Invoke为C#提供了调用其他语言代码的服务。</p>
<h2 id="1-4-MinGW和Cygwin"><a href="#1-4-MinGW和Cygwin" class="headerlink" title="1.4 MinGW和Cygwin"></a>1.4 MinGW和Cygwin</h2><p>在生成Android使用的链接库时，需要使用Linux的编译工具，若想在Windows环境下使用Linux的编译工具（gcc/g++），则需要一个平台进行转换，也就是MinGW或Cygwin。</p>
<p>MinGW（ Minimalistic GNU for Windows），可被视为是Windows版本下的GCC，把代码中的LInux方式调用替换为对应的Windows调用方式。其中Msys子项目提供了一些模拟Linux的Shell和基础工具。</p>
<p>Cygwin 是在Windows平台上运行的unix模拟环境，Cygwin更像一个平台，模拟了Linux的接口，提供了运行在它上面的程序使用。</p>
<blockquote>
<ul>
<li>MinGW生成的程序，究其本质<strong>调用的是Kernel.32导出的标准Windows系统API</strong>，在windows下Mingw的编译性能会高一些，编译速度也会快一些。</li>
<li>Cygwin更像一个平台，它<strong>相对完整地模拟了LInux</strong>，提供了一个接近2M的Cygwin1.dll的文件作为目标库，来模拟Linux系统的接口，但是相对来说编译的速度就要慢一些。如果想要在Windows上开发可以运行在LInux上的程序，应该选用Cygwin。</li>
</ul>
</blockquote>
<p>资料:<a href="https://www.cnblogs.com/zoe-mine/p/7056369.html" target="_blank" rel="noopener">https://www.cnblogs.com/zoe-mine/p/7056369.html</a></p>
<p>MinGW和Cygwin的安装请自行查看资料</p>
<h1 id="二-Windows下的链接库调用"><a href="#二-Windows下的链接库调用" class="headerlink" title="二 Windows下的链接库调用"></a>二 Windows下的链接库调用</h1><h2 id="2-0-准备环境"><a href="#2-0-准备环境" class="headerlink" title="2.0 准备环境"></a>2.0 准备环境</h2><p>VS2015，<a href="http://www.dependencywalker.com/" target="_blank" rel="noopener">Dependency Walker</a>（用于查看DLL中是否有写好的方法）</p>
<h2 id="2-1-DLL项目"><a href="#2-1-DLL项目" class="headerlink" title="2.1 DLL项目"></a>2.1 DLL项目</h2><h3 id="2-1-1建立DLL项目"><a href="#2-1-1建立DLL项目" class="headerlink" title="2.1.1建立DLL项目"></a>2.1.1建立DLL项目</h3><p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011554868057.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554868057.png" alt="Image 0011554868057.png"></a></p>
<p>如果没有Win32，则需要下载模板</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011554869322.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554869322.png" alt="Image 0011554869322.png"></a></p>
<h3 id="2-1-2文件介绍"><a href="#2-1-2文件介绍" class="headerlink" title="2.1.2文件介绍"></a>2.1.2文件介绍</h3><p>新建项目完成后，会有如下几个文件：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011554869544.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554869544.png" alt="Image 0011554869544.png"></a></p>
<ul>
<li><p>（1）stdafx.h：用于包含标准系统包含的头文件，用户需要的其他标准头文件也写在这里。</p>
</li>
<li><p>（2）stdafx.cpp：和stdafx.h对应，用于对stdafx.h进行预编译处理所谓头文件预编译，把一个工程(Project)中使用的一些MFC标准头文件预先编译，以后该工程编译时，不再编译这部分头文件，仅仅使用预编译的结果。这样可以加快编译速度，节省时间,编译结果文件是projectname.pch,stdafx.cpp可以在C++项目中加快编译速度。如果不使用MFC可以将其删除。</p>
</li>
<li><p>（3） targetver.h：定义dll最高可以使用的windows版本</p>
</li>
<li><p>（4） <strong>dllmain.cpp：</strong>dll的程序入口点。</p>
</li>
<li><p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555668421.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555668421.png" alt="Image 0011555668421.png"></a></p>
</li>
<li><p>| DLL_PROCESS_ATTACH | 进程被调用，DLL被连接到当前进程并被初始化   |<br>| —————— | ——————————————- |<br>| DLL_THREAD_ATTACH  | 当前进程创建一个新线程，DLL在新线程内被调用 |<br>| DLL_PROCESS_DETACH | 调用DLL的进程被终止，DLL被卸载              |<br>| DLL_THREAD_DETACH  | 调用DLL的线程被终止，DLL被卸载              |</p>
</li>
</ul>
<h3 id="2-1-3-将DLL项目修改为C"><a href="#2-1-3-将DLL项目修改为C" class="headerlink" title="2.1.3 将DLL项目修改为C"></a>2.1.3 将DLL项目修改为C</h3><p>此时项目需要做一些操作，才能修改为纯C的DLL库。</p>
<p>（1）.将预编译头修改为：创建<strong>(/YC)</strong></p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011554870532.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554870532.png" alt="Image 0011554870532.png"></a></p>
<p>（2）.修改为：编译为C代码<strong>（/TC）</strong><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011554870620.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011554870620.png" alt="Image 0011554870620.png"></a></p>
<p>（3）.删除stdafx.cpp，将其他cpp文件后缀修改为.c。修改完如图（Ccallback，CFunction，Cstruct是我写好的.c，可忽略）：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555056920.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555056920.png" alt="Image 0011555056920.png"></a></p>
<h3 id="2-1-4-编写C代码"><a href="#2-1-4-编写C代码" class="headerlink" title="2.1.4 编写C代码"></a>2.1.4 编写C代码</h3><p>（1）编写方法，命名为CFunction.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CFunction.cpp : 定义 DLL 应用程序的导出函数。</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"></span><br><span class="line">__declspec(dllexport) <span class="function"><span class="keyword">int</span> <span class="title">NoArgReturnSth</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"NoArgReturnSth()调用:\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">99999</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__declspec(dllexport) <span class="function"><span class="keyword">int</span> <span class="title">Sum</span><span class="params">(<span class="keyword">int</span> a , <span class="keyword">int</span> b)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"Sum(int a , int b)调用:\n"</span>);</span><br><span class="line">  <span class="keyword">return</span> a + b;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">__declspec(dllexport) <span class="function"><span class="keyword">int</span> <span class="title">SetNumZero</span><span class="params">(<span class="keyword">int</span>* a)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"int SetNumZero(int *a)调用：\n"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"int SetNumZero(int *a)调用,int a的内存位置：%d\n"</span>,a);</span><br><span class="line">  *a = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> __declspec(dllexport) <span class="function"><span class="keyword">int</span> <span class="title">sendMessage</span><span class="params">(<span class="keyword">char</span>* msg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">"int sendMessage(char* msg)调用：\n"</span>);</span><br><span class="line">   <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">   <span class="keyword">for</span>(;*(msg + i) != <span class="literal">NULL</span>;i++ )</span><br><span class="line">   &#123; </span><br><span class="line">    *(msg + i) = *(msg + i) - <span class="number">32</span>;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（2）编写方法，命名为CStruct.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  <span class="keyword">int</span> osVersion;</span><br><span class="line">  <span class="keyword">int</span> majorVersion;</span><br><span class="line">  <span class="keyword">int</span> minorVersion;</span><br><span class="line">  <span class="keyword">int</span> buildNum;</span><br><span class="line">  <span class="keyword">int</span> platFormId;</span><br><span class="line">  <span class="keyword">char</span> szVersion[<span class="number">128</span>];</span><br><span class="line">&#125;OSINFO;</span><br><span class="line"></span><br><span class="line"><span class="comment">//（传递结构体指针）</span></span><br><span class="line">__declspec(dllexport) <span class="function"><span class="keyword">int</span> <span class="title">SetVersionPtr</span><span class="params">(OSINFO *info)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> * str = <span class="string">"Hello DLL"</span>;</span><br><span class="line">  info-&gt;osVersion = <span class="number">100</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"测试内容%d\n"</span>, info-&gt;majorVersion);</span><br><span class="line">  <span class="built_in">strcpy</span>(info-&gt;szVersion, str);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（3）编写方法，命名为Ccallback.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"stdafx.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">typedef</span> <span class="title">int</span><span class="params">(*pfCallBack)</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">char</span> b[])</span></span>;</span><br><span class="line"></span><br><span class="line">pfCallBack CallBackfun = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span> ch[<span class="number">100</span>];</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">__declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">SetCB</span><span class="params">(<span class="keyword">int</span>(*pfCallBack)(<span class="keyword">int</span> a, <span class="keyword">char</span> b[]))</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  CallBackfun = pfCallBack;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> __declspec(dllexport) <span class="function"><span class="keyword">void</span> <span class="title">callTheCB</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> a = <span class="number">4</span>;</span><br><span class="line">  <span class="built_in">memset</span>(ch, <span class="string">'\0'</span>, <span class="number">100</span>);</span><br><span class="line">  <span class="built_in">strcpy</span>(ch, <span class="string">"aabbcc"</span>);</span><br><span class="line">  CallBackfun(a, ch);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注：printf方法需要在stdafx.h文件中添加#include “stdio.h”。</p>
<h3 id="2-1-5-导出DLL"><a href="#2-1-5-导出DLL" class="headerlink" title="2.1.5 导出DLL"></a>2.1.5 导出DLL</h3><p>（1）编译，编译成功后在项目的Debug目录下会有如下几个文件，（我的项目名字叫CFunctionw，所以生成的叫CFunction）：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555058072.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555058072.png" alt="Image 0011555058072.png"></a></p>
<p>（2）检查DLL是否存在需调用的方法，下载<a href="http://www.dependencywalker.com/" target="_blank" rel="noopener">Dependency Walker</a>，安装后打开CFunction.dll：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555058152.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555058152.png" alt="Image 0011555058152.png"></a></p>
<p>可以看到有写好的方法，至此，DLL编写完成。</p>
<h2 id="2-2-C-调用DLL库（简单的控制台Demo）"><a href="#2-2-C-调用DLL库（简单的控制台Demo）" class="headerlink" title="2.2 C#调用DLL库（简单的控制台Demo）"></a>2.2 C#调用DLL库（简单的控制台Demo）</h2><hr>
<p>（1）新建一个C#控制台项目。</p>
<p>（2）在Main方法中调用DLL：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System;</span><br><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> System.Linq;</span><br><span class="line"><span class="keyword">using</span> System.Text;</span><br><span class="line"><span class="keyword">using</span> System.Threading.Tasks;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> ConsoleApplication1</span><br><span class="line">&#123;</span><br><span class="line">    [StructLayout(LayoutKind.Sequential)]</span><br><span class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">struct</span> <span class="title">OSINFO</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> osVersion;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> majorVersion;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> minorVersion;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> buildNum;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">int</span> platFormId;</span><br><span class="line">        [MarshalAs(UnmanagedType.ByValTStr, SizeConst = <span class="number">128</span>)]</span><br><span class="line">        <span class="keyword">public</span> <span class="built_in">string</span> szVersion;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Program</span></span></span><br><span class="line"><span class="class">    &#123;</span></span><br><span class="line">        <span class="comment">//定义一个委托，其返回类型和形参与方法体的返回类型形参一致</span></span><br><span class="line">        <span class="comment">//一定要加上这句，要不然C#中的回调函数只要被调用一次，程序就异常退出了</span></span><br><span class="line">        [UnmanagedFunctionPointer(CallingConvention.Cdecl)]  </span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> delegate <span class="keyword">int</span> <span class="title">callBackHandler</span><span class="params">(<span class="keyword">int</span> a, [MarshalAs(UnmanagedType.LPStr)]StringBuilder b)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="function">internal <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span><span class="params">(<span class="built_in">string</span>[] args)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">int</span> b = <span class="number">2</span>;</span><br><span class="line">            Console.WriteLine(<span class="string">"------------------------------"</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">"DLL func execute:&#123;0&#125;"</span>, NoArgReturnSth());</span><br><span class="line">            Console.WriteLine(<span class="string">"------------------------------"</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">"DLL func execute:&#123;0&#125;"</span>, SUM(a,b));</span><br><span class="line">            Console.WriteLine(<span class="string">"------------------------------"</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">"修改前的a:&#123;0&#125;"</span>, a);</span><br><span class="line">            Console.WriteLine(<span class="string">"DLL func execute:&#123;0&#125;"</span>, SetNumZero(ref a));</span><br><span class="line">            Console.WriteLine(<span class="string">"修改后的a:&#123;0&#125;"</span>, a);</span><br><span class="line">            Console.WriteLine(<span class="string">"------------------------------"</span>);</span><br><span class="line">            StringBuilder buf = <span class="keyword">new</span> StringBuilder(<span class="number">2048</span>);</span><br><span class="line">            buf.Append(<span class="string">"helloworld"</span>);</span><br><span class="line">            Console.WriteLine(<span class="string">"传入字符串:&#123;0&#125;"</span>, buf);</span><br><span class="line">            sendMessage(buf);</span><br><span class="line">            Console.WriteLine(<span class="string">"传出字符串:&#123;0&#125;"</span>, buf.ToString());</span><br><span class="line">            Console.WriteLine(<span class="string">"------------------------------"</span>);</span><br><span class="line">            initStruct();</span><br><span class="line">            Console.WriteLine(<span class="string">"------------------------------"</span>);</span><br><span class="line">            callBackHandler fun = <span class="keyword">new</span> callBackHandler(localFun);</span><br><span class="line">            SetCB(fun);</span><br><span class="line">            callTheCB();</span><br><span class="line">            Console.WriteLine(<span class="string">"------------------------------"</span>);</span><br><span class="line">            Console.Read();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//普通无参方法</span></span><br><span class="line">        [DllImport(<span class="string">"CFunction.dll"</span>)]</span><br><span class="line">        <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">NoArgReturnSth</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//有参int方法</span></span><br><span class="line">        [DllImport(<span class="string">"CFunction.dll"</span>, EntryPoint = <span class="string">"Sum"</span>, CallingConvention = CallingConvention.Cdecl)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span>  <span class="keyword">int</span> <span class="title">SUM</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//传入int指针方法</span></span><br><span class="line">        [DllImport(<span class="string">"CFunction.dll"</span>, EntryPoint = <span class="string">"SetNumZero"</span>, CallingConvention = CallingConvention.Cdecl)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">SetNumZero</span><span class="params">(ref <span class="keyword">int</span> a)</span></span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//传入字符串指针方法</span></span><br><span class="line">        [DllImport(<span class="string">"CFunction.dll"</span>, CallingConvention = CallingConvention.Cdecl)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">sendMessage</span><span class="params">(StringBuilder msg)</span></span>;</span><br><span class="line">        <span class="comment">//传入结构体方法</span></span><br><span class="line">        [DllImport(<span class="string">"CFunction.dll"</span>, EntryPoint = <span class="string">"SetVersionPtr"</span>, CallingConvention = CallingConvention.Cdecl)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">SetVersionPtr</span><span class="params">(ref OSINFO info)</span></span>;</span><br><span class="line">        <span class="comment">//结构体初始化，并调用DLL方法。</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initStruct</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            IntPtr pv = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(OSINFO)));</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++)</span><br><span class="line">            &#123;</span><br><span class="line">                Marshal.WriteInt32(pv, i * Marshal.SizeOf(typeof(Int32)), ((Int32)(i + <span class="number">1</span>)));</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            OSINFO entries = (OSINFO)Marshal.PtrToStructure(pv, typeof(OSINFO));</span><br><span class="line">            entries.majorVersion = <span class="number">999</span>;</span><br><span class="line">            <span class="keyword">if</span> (SetVersionPtr(ref entries) == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                Console.WriteLine(<span class="string">"--osVersion:&#123;0&#125;"</span>, entries.osVersion);</span><br><span class="line">                Console.WriteLine(<span class="string">"--Major:&#123;0&#125;"</span>, entries.majorVersion);</span><br><span class="line">                Console.WriteLine(<span class="string">"--Minor:&#123;0&#125;"</span>, entries.minorVersion);</span><br><span class="line">                Console.WriteLine(<span class="string">"--BuildNum:&#123;0&#125;"</span>, entries.buildNum);</span><br><span class="line">                Console.WriteLine(<span class="string">"--szVersion:&#123;0&#125;"</span>, entries.szVersion);</span><br><span class="line">            &#125;</span><br><span class="line">            Marshal.FreeHGlobal(pv);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//传入委托方法</span></span><br><span class="line">        [DllImport(<span class="string">"CFunction.dll"</span>, CallingConvention = CallingConvention.Cdecl)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">SetCB</span><span class="params">(callBackHandler fun1)</span></span>;</span><br><span class="line">        <span class="comment">//回调方法</span></span><br><span class="line">        [DllImport(<span class="string">"CFunction.dll"</span>, CallingConvention = CallingConvention.Cdecl)]</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">callTheCB</span><span class="params">()</span></span>;</span><br><span class="line">         <span class="comment">//本地委托方法</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">localFun</span><span class="params">(<span class="keyword">int</span> a, [MarshalAs(UnmanagedType.LPStr)] StringBuilder b)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            Console.WriteLine(<span class="string">"回调:&#123;0&#125;"</span>, b.ToString());</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>CallingConvention = CallingConvention.Cdecl</strong></p>
<p>首先引入System.Runtime.InteropServices，然后导入DLL，格式为：</p>
<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DllImport(<span class="meta-string">"dllname.dll"</span>),EntryPoint = <span class="meta-string">"functionname"</span>,CallingConvention = CallingConvention.Cdecl,</span>]</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">functionname2</span>(<span class="params"></span>)</span>;</span><br></pre></td></tr></table></figure>
<p>[DllImport(“CFunction.dll”)]用于导入DLL。EntryPoint 、CallingConvention 是两个较常用的属性，EntryPoint 用于指定DLL中的方法名，如果DLL和C#中声明的方法名相同，则该属性可忽略。CallingConvention用于指定由哪一方负责处理堆栈，值Cdecl为调用方清理堆栈。</p>
<p>如果不使用CallingConvention，会提示：<em>“C#调用C++DLL文件 报错调用导致堆栈不对称。原因可能是托管的 PInvoke 签名与非托管的目标签名不匹配”</em>的错误。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[UnmanagedFunctionPointer(CallingConvention.Cdecl)]</span><br></pre></td></tr></table></figure>
<p>UnmanagedFunctionPointe表示动态使用未托管的dll函数指针</p>
<blockquote>
<p>CallingConvention.Cdecl：C调用约定（即用<strong>cdecl关键字说明）按从右至左的顺序压参数入栈，由调用者把参数弹出栈。对于传送参数的内存栈是由调用者来维护的（正因为如此，实现可变参数的函数只能使用该调用约定）。另外，在函数名修饰约定方面也有所不同。_cdecl是C和C＋＋程序的缺省调用方式。每一个调用它的函数都包含清空堆栈的代码，所以产生的可执行文件大小会比调用_stdcall函数的大。函数采用从右到左的压栈方式。VC将函数编译后会在函数名前面加上下划线前缀，是MFC缺省调用约定；<br>CallingConvention.StdDecl：</strong>stdcall调用约定相当于16位动态库中经常使用的PASCAL调用约定。在32位的VC++5.0中PASCAL调用约定不再被支持（实际上它已被定义为<strong>stdcall。除了</strong>pascal外，<strong>fortran和</strong>syscall也不被支持），取而代之的是__stdcall调用约定。两者实质上是一致的，即函数的参数自右向左通过栈传递，被调用的函数在返回前清理传送参数的内存栈，但不同的是函数名的修饰部分（关于函数名的修饰部分在后面将详细说明）。_stdcall是Pascal程序的缺省调用方式，通常用于Win32Api中，函数采用从右到左的压栈方式，自己在退出时清空堆栈。VC将函数编译后会在函数名前面加上下划线前缀，在函数名后加上”@”和参数的字节数；</p>
</blockquote>
<p>还有一些其他的属性，详情看：<a href="https://blog.csdn.net/sdl2005lyx/article/details/6796037" target="_blank" rel="noopener">平台调用P-INVOKE(一)–(基础篇)</a></p>
<p>注意C#和DLL中的方法的返回值，参数个数、类型、顺序必须一致。方法名可以不一致。</p>
<p>（3）运行代码，控制台会输出对应方法及其返回值：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555059881.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555059881.png" alt="Image 0011555059881.png"></a></p>
<p>注：将DLL和用于调试的控制的控制台项目放入同一解决方案内，修改DLL的生成路径可以简化调试过程，避免每次生成DLL在拷贝到Debug目录中。</p>
<h2 id="2-3在Unity下使用DLL"><a href="#2-3在Unity下使用DLL" class="headerlink" title="2.3在Unity下使用DLL"></a>2.3在Unity下使用DLL</h2><hr>
<p>（1）将DLL编译为64位，不然在Unity中会有关于32/64位的问题。为了测试方便，统一调整为64位。</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555061641.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555061641.png" alt="Image 0011555061641.png"></a></p>
<p>（2）新建Unity项目，在Assets目录下新建Plugins文件夹，在Plugins文件夹下建立x86，x86_64文件夹。如图（忽略Android）：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555061782.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555061782.png" alt="Image 0011555061782.png"></a></p>
<p>之所以新建x86，x86_64文件夹是为了区分32/64位的DLL，直接拖到Plugins也可以。Plugins文件夹中若存在这两个文件夹，则dll必须放到两个文件夹中，否则会出现找不到dll的情况。（我的2017.4.16f1不存在这种情况。）</p>
<p>（3）修改DLL的属性，将属性修改为和图片一致</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555062363.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555062363.png" alt="Image 0011555062363.png"></a></p>
<p>（4）编写C#脚本：</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Collections.Generic;</span><br><span class="line"><span class="keyword">using</span> UnityEngine;</span><br><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NewBehaviourScript</span> :</span> MonoBehaviour &#123;</span><br><span class="line">    [DllImport(<span class="string">"CFunction"</span>)]</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">int</span> <span class="title">NoArgReturnSth</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="keyword">int</span> i = NoArgReturnSth();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">OnGUI</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        GUI.Button(<span class="keyword">new</span> Rect(<span class="number">1</span>, <span class="number">1</span>, <span class="number">200</span>, <span class="number">100</span>), i.ToString());</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>csharpcsharp随便拖到一个GameObject上，运行：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555062503.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555062503.png" alt="Image 0011555062503.png"></a></p>
<h3 id="异常信息"><a href="#异常信息" class="headerlink" title="异常信息"></a>异常信息</h3><p>此报错只针对Windows，后面会有其他平台的异常信息。</p>
<p>（1）DllNotFoundException: 64位运行32位的DLL会报这个错。</p>
<p>（2）Failed to load ‘Assets/Plugins/xxx.dll’, expected x64 architecture, but was x86 architecture. You must recompile your plugin for x64 architecture.：DLL文件没有选择对应的CPU</p>
<p>（3）EntryPointNotFoundException：EntryPoint没写的情况下就是C#方法名字和DLL名字对不上，写了就是EntryPoint没写对。</p>
<h1 id="三-Android下的链接库调用"><a href="#三-Android下的链接库调用" class="headerlink" title="三 Android下的链接库调用"></a>三 Android下的链接库调用</h1><p>下面介绍三种我用的，在windows下生成.so的方法。</p>
<h2 id="3-1-通过NDK生成-so文件"><a href="#3-1-通过NDK生成-so文件" class="headerlink" title="3.1 通过NDK生成.so文件"></a>3.1 通过NDK生成.so文件</h2><h3 id="3-1-1-准备环境"><a href="#3-1-1-准备环境" class="headerlink" title="3.1.1 准备环境"></a>3.1.1 准备环境</h3><p>（1）配置好NDK，SDK，JDK以及环境变量。</p>
<p>（2）新建一个文件夹，将写好的.c，.h放入。新建Android.mk，Application.mk文件。</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555065573.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555065573.png" alt="Image 0011555065573.png"></a></p>
<p><em>注：.c文件和.h文件的写法与DLL中稍有不同。</em></p>
<p>文件介绍：</p>
<p><a href="https://developer.android.com/ndk/guides/android_mk" target="_blank" rel="noopener">https://developer.android.com/ndk/guides/android_mk</a></p>
<p><strong>Android.mk：</strong>Android提供的一种makefile文件，用于引导生成.so。</p>
<p><strong>Application.mk：</strong>androidNDK构建系统使用的一个可选构建文件，用于描述native模块。</p>
<h3 id="3-1-2-配置文件"><a href="#3-1-2-配置文件" class="headerlink" title="3.1.2 配置文件"></a>3.1.2 配置文件</h3><p>（3）配置<strong>Android.mk：</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">#指向一个编译脚本，由编译系统提供</span><br><span class="line">include $(CLEAR_VARS)</span><br><span class="line"></span><br><span class="line">#这个不太清楚 应该是处理器类型</span><br><span class="line">LOCAL_ARM_MODE  := arm</span><br><span class="line"></span><br><span class="line">#当前文件路径</span><br><span class="line">LOCAL_PATH      := $(NDK_PROJECT_PATH)</span><br><span class="line"></span><br><span class="line">#库名称</span><br><span class="line">LOCAL_MODULE    := libnative</span><br><span class="line"></span><br><span class="line"># 表示用于 <span class="selector-tag">C</span> 编译器的选项，<span class="selector-tag">Werror</span>将所有的警告当成错误进行处理</span><br><span class="line">LOCAL_CFLAGS    := -Werror</span><br><span class="line"></span><br><span class="line">#指定编译的源文件名称,</span><br><span class="line">LOCAL_SRC_FILES := NativeCode.c CFunction.c</span><br><span class="line"></span><br><span class="line">#允许打印<span class="selector-tag">Log</span></span><br><span class="line">LOCAL_LDLIBS    := -llog</span><br><span class="line"></span><br><span class="line">#告诉编译器生成<span class="selector-class">.so</span></span><br><span class="line">include $(BUILD_SHARED_LIBRARY)</span><br></pre></td></tr></table></figure>
<p>（4）配置<strong>Application.mk</strong></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#优化选项 可选release/debug</span><br><span class="line">APP_OPTIM        := release</span><br><span class="line"></span><br><span class="line">#选择需要支持的<span class="selector-tag">cpu</span></span><br><span class="line">APP_ABI          := armeabi</span><br><span class="line"></span><br><span class="line">#支持的最低<span class="selector-tag">Android</span>平台</span><br><span class="line">APP_PLATFORM     := android-16</span><br><span class="line"></span><br><span class="line">#指定执行脚本</span><br><span class="line">APP_BUILD_SCRIPT := Android.mk</span><br></pre></td></tr></table></figure>
<p>注：如果提示APP_PLATFORM版本过低，对应调高即可。</p>
<h3 id="3-1-3-编译"><a href="#3-1-3-编译" class="headerlink" title="3.1.3 编译"></a>3.1.3 编译</h3><p>（5）打开命令行，cd到文件目录编译。</p>
<p>编译指令：<code>ndk-build NDK_PROJECT_PATH=. NDK_APPLICATION_MK=Application.mk</code></p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555068565.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555068565.png" alt="Image 0011555068565.png"></a></p>
<p>编译后目录内会产生两个文件夹libs和obj，在libs的armeabi-v7a文件夹下会有我们编译好的libnative.so。</p>
<h2 id="3-2-通过Cmake生成-so文件"><a href="#3-2-通过Cmake生成-so文件" class="headerlink" title="3.2 通过Cmake生成.so文件"></a>3.2 通过Cmake生成.so文件</h2><hr>
<h3 id="3-2-1-准备环境"><a href="#3-2-1-准备环境" class="headerlink" title="3.2.1 准备环境"></a>3.2.1 准备环境</h3><p>我是通过装Android Studio来安装的以下配置，但实际上编译用不到AS。</p>
<p>（1）在Android Studio安装好LLDB，CMake，NDK。（NDK如果之前装过可以自行配置），LLDB，CMake也可以在官网下载单独安装。</p>
<p>（2）打开settings查看SDK和NDK的所在位置：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555295955.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555295955.png" alt="Image 0011555295955.png"></a></p>
<p>打开位置，我的是C:\Users\usename\AppData\Local\Android\Sdk，然后找到如下文件夹：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555296277.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555296277.png" alt="Image 0011555296277.png"></a></p>
<p><strong>配置cmake和ninja的环境变量：</strong></p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555296407.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555296407.png" alt="Image 0011555296407.png"></a></p>
<p><strong>验证是否配置成功：</strong></p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555296521.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555296521.png" alt="Image 0011555296521.png"></a></p>
<p>如图就是配置成功了。</p>
<p>（3）查看<strong>android.toolchain.cmake文件</strong>：在ndk所在的文件夹下，build-cmake-android.toolchain.cmake。该文件很重要，如果cmake目录下没有此文件，就去<a href="https://developer.android.com/ndk/guides/cmake.html下载。" target="_blank" rel="noopener">https://developer.android.com/ndk/guides/cmake.html下载。</a></p>
<p>（4）准备代码：随便找个地方新建一个文件夹，新建build，include，src文件夹，将.c放入src，.h放入include：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555297411.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555297411.png" alt="Image 0011555297411.png"></a></p>
<p>（5）新建CMakeLists.txt，并输入如下内容：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">cmake_minimum_required</span>(<span class="selector-tag">VERSION</span> 3<span class="selector-class">.6</span>)</span><br><span class="line">file(GLOB native_srcs "$&#123;CMAKE_SOURCE_DIR&#125;/src/*.c")</span><br><span class="line">include_directories($&#123;CMAKE_SOURCE_DIR&#125;/include)</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#STATIC</span>表示编译结果为静态库<span class="selector-class">.a</span>,如果想为动态库<span class="selector-class">.so</span>,可改为<span class="selector-tag">SHARED</span></span><br><span class="line"></span><br><span class="line">add_library(Add SHARED $&#123;native_srcs&#125;) </span><br><span class="line"><span class="selector-tag">target_link_libraries</span>(<span class="selector-tag">Add</span>)</span><br></pre></td></tr></table></figure>
<p>（6）在build文件夹下新建批处理文件build.bat，内容如下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">set toolchain=C:/Users/wenmai/AppData/Local/Android/Sdk/ndk-bundle/build/cmake/android.toolchain.cmake</span><br><span class="line">set android_ndk=C:/Users/wenmai/AppData/Local/Android/Sdk/ndk-bundle</span><br><span class="line">set build_type=Release</span><br><span class="line">set gernerator="Ninja"</span><br><span class="line">if not exist %1 md %1</span><br><span class="line">cd %1</span><br><span class="line">cmake ../.. -DCMAKE_TOOLCHAIN_FILE=%toolchain% -DANDROID_NDK=%android_ndk% -DCMAKE_BUILD_TYPE=%build_type% -DANDROID_ABI="%1" -DCMAKE_GENERATOR=%gernerator%</span><br><span class="line">ninja</span><br></pre></td></tr></table></figure>
<p>cmake ../..的意思是使用cmake交叉编译当前工程，并将-DCMAKE_GENERATOR指向了ninja.exe。%1运行.bat要传的参数,需要传Android ABI名称，如：arm64-v8a,armeabi armeabi-v7a mips,mips64,x86,x86_64。</p>
<p>（7）打开命令行，cd到build目录，输入：build.bat armeabi-v7a：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555298228.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555298228.png" alt="Image 0011555298228.png"></a></p>
<p>可以在 armeabi-v7a目录下看到生成了libAdd.so文件。</p>
<p>如果出现如下图所示的错误，可以先仔细检查配置文件是否写对，并且build.bat传入的参数是否正确：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555153592.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555153592.png" alt="Image 0011555153592.png"></a></p>
<h2 id="3-3-使用Android-Studio生成-so"><a href="#3-3-使用Android-Studio生成-so" class="headerlink" title="3.3 使用Android Studio生成.so"></a>3.3 使用Android Studio生成.so</h2><p><em>注：Android Studio在最近的版本中弃用了使用gcc编译器，改为使用Clang代替。</em></p>
<p>下面利用AS和NDK来生成so，Cmake也可以使用此方法，文字不再做介绍。</p>
<h3 id="3-3-1-准备环境"><a href="#3-3-1-准备环境" class="headerlink" title="3.3.1 准备环境"></a>3.3.1 准备环境</h3><hr>
<p>（1）安装好Android Studio，确保可以正常运行。</p>
<p>（2）<a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555137646.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555137646.png" alt="Image 0011555137646.png"></a></p>
<p>界面位置：File-Settings-System Settings-Android-SDKTools</p>
<p>在AS中下载这些东西似乎需要翻墙，没有验证过。</p>
<p>文件介绍：</p>
<ul>
<li>CMake：一款外部构建工具，可与 Gradle 搭配使用来构建原生库。如果您只计划使用 ndk-build，则不需要此组件。</li>
<li>LLDB：一种调试程序，Android Studio 使用它来调试原生代码。</li>
</ul>
<h3 id="3-3-2-项目配置"><a href="#3-3-2-项目配置" class="headerlink" title="3.3.2 项目配置"></a>3.3.2 项目配置</h3><p>（1）先新建一个项目，（我的叫FuckSO）。然后切换工程目录为Project，（默认是Android），然后打开Project Structure-SDK Location，确认ndk已经配置好。</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Honeycam 2019-04-13 15-11-35.gif" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Honeycam%202019-04-13%2015-11-35.gif" alt="Honeycam 2019-04-13 15-11-35.gif"></a></p>
<p>（2）在gradle.properties中添加一句：<strong>android.useDeprecatedNdk=true</strong>。为了向后兼容</p>
<p>（3）在build.gradle文件下添加ndk，CMake节点：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555140513.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555140513.png" alt="Image 0011555140513.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: &apos;com.android.application&apos;</span><br><span class="line"></span><br><span class="line">android &#123;</span><br><span class="line">    compileSdkVersion 28</span><br><span class="line">    defaultConfig &#123;</span><br><span class="line">        applicationId &apos;com.example.hellojni&apos;</span><br><span class="line">        minSdkVersion 23</span><br><span class="line">        targetSdkVersion 28</span><br><span class="line">        versionCode 1</span><br><span class="line">        versionName &quot;1.0&quot;</span><br><span class="line">    &#125;</span><br><span class="line">    buildTypes &#123;</span><br><span class="line">        release &#123;</span><br><span class="line">            minifyEnabled false</span><br><span class="line">            proguardFiles getDefaultProguardFile(&apos;proguard-android.txt&apos;),</span><br><span class="line">                    &apos;proguard-rules.pro&apos;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    externalNativeBuild &#123;</span><br><span class="line">        cmake &#123;</span><br><span class="line">            version &apos;3.10.2&apos;</span><br><span class="line">            path &quot;src/main/cpp/CMakeLists.txt&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    flavorDimensions &apos;cpuArch&apos;</span><br><span class="line">    productFlavors &#123;</span><br><span class="line">        arm7 &#123;</span><br><span class="line">            dimension &apos;cpuArch&apos;</span><br><span class="line">            ndk &#123;</span><br><span class="line">                abiFilter &apos;armeabi-v7a&apos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        arm8 &#123;</span><br><span class="line">            dimension &apos;cpuArch&apos;</span><br><span class="line">            ndk &#123;</span><br><span class="line">                abiFilters &apos;arm64-v8a&apos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        x86 &#123;</span><br><span class="line">            dimension &apos;cpuArch&apos;</span><br><span class="line">            ndk &#123;</span><br><span class="line">                abiFilter &apos;x86&apos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        x86_64 &#123;</span><br><span class="line">            dimension &apos;cpuArch&apos;</span><br><span class="line">            ndk &#123;</span><br><span class="line">                abiFilter &apos;x86_64&apos;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        universal &#123;</span><br><span class="line">            dimension &apos;cpuArch&apos;</span><br><span class="line">            // include all default ABIs. with NDK-r16,  it is:</span><br><span class="line">            //   armeabi-v7a, arm64-v8a, x86, x86_64</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation fileTree(dir: &apos;libs&apos;, include: [&apos;*.jar&apos;])</span><br><span class="line">    implementation &apos;com.android.support:appcompat-v7:28.0.0&apos;</span><br><span class="line">    implementation &apos;com.android.support.constraint:constraint-layout:1.1.3&apos;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（4）（如果不需要在Android Studio中调试此步骤可以跳过）在java目录下新建一个类，<strong>CCodeHelper</strong>。在静态代码中加载.c文件，并定义一个方法用于链接.c中的方法。</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555141665.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555141665.png" alt="Image 0011555141665.png"></a></p>
<p>（5）在项目文件夹-app-src-main下新建cpp文件夹，并新建.c文件：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555141480.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555141480.png" alt="Image 0011555141480.png"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">#include  &lt;jni.h&gt;</span><br><span class="line">#include &lt;string.h&gt;</span><br><span class="line">int  Java_com_example_fuckso_CCodeHelper_magicMethod()</span><br><span class="line">&#123;</span><br><span class="line">#if defined(__arm__)</span><br><span class="line">    #if defined(__ARM_ARCH_7A__)</span><br><span class="line">    #if defined(__ARM_NEON__)</span><br><span class="line">      #if defined(__ARM_PCS_VFP)</span><br><span class="line">        #define ABI &quot;armeabi-v7a/NEON (hard-float)&quot;</span><br><span class="line">      #else</span><br><span class="line">        #define ABI &quot;armeabi-v7a/NEON&quot;</span><br><span class="line">      #endif</span><br><span class="line">    #else</span><br><span class="line">      #if defined(__ARM_PCS_VFP)</span><br><span class="line">        #define ABI &quot;armeabi-v7a (hard-float)&quot;</span><br><span class="line">      #else</span><br><span class="line">        #define ABI &quot;armeabi-v7a&quot;</span><br><span class="line">      #endif</span><br><span class="line">    #endif</span><br><span class="line">  #else</span><br><span class="line">   #define ABI &quot;armeabi&quot;</span><br><span class="line">  #endif</span><br><span class="line">#elif defined(__i386__)</span><br><span class="line">#define ABI &quot;x86&quot;</span><br><span class="line">#elif defined(__x86_64__)</span><br><span class="line">#define ABI &quot;x86_64&quot;</span><br><span class="line">#elif defined(__mips64)  /* mips64el-* toolchain defines __mips__ too */</span><br><span class="line">#define ABI &quot;mips64&quot;</span><br><span class="line">#elif defined(__mips__)</span><br><span class="line">#define ABI &quot;mips&quot;</span><br><span class="line">#elif defined(__aarch64__)</span><br><span class="line">#define ABI &quot;arm64-v8a&quot;</span><br><span class="line">#else</span><br><span class="line">#define ABI &quot;unknown&quot;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    return 999999999;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意方法的名字<strong>Java_com_example_fuckso_CCodeHelper_magicMethod，</strong>该方法与CCodeHelper中的方法对应。但多了Java_com_example_fuckso_CCodeHelper_，这是在Android项目中定义C/C++库方法的规则，规则为：“包名_类名_方法名”，在java类中直接使用方法名来进行调用。</p>
<p>但把so拿给unity使用时，必须要使用全名也就是<strong>Java_com_example_fuckso_CCodeHelper_magicMethod</strong>才能调用。</p>
<p>（如果不需要在Android Studio中调试，方法名随便写就可以。）</p>
<p>（6）再和build.gradle同级别目录新建CMakeLists.txt，写入如下内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cmake_minimum_required(VERSION 3.4.1)</span><br><span class="line">add_library(</span><br><span class="line">        CNativeFunction</span><br><span class="line">         SHARED</span><br><span class="line">        app/src/main/cpp/CNativeFunction.c</span><br><span class="line">)</span><br><span class="line">find_library(</span><br><span class="line">          log-lib</span><br><span class="line">          log</span><br><span class="line">)</span><br><span class="line">target_link_libraries(</span><br><span class="line">                   CNativeFunction</span><br><span class="line">                   $&#123;log-lib&#125;</span><br><span class="line"> )</span><br></pre></td></tr></table></figure>
<p>（7）ctrl+F9 编译。编译成功后，会在FuckSO\app\build\intermediates\cmake\debug\obj下对应的cpu类型下找到.so文件。</p>
<h2 id="3-3-Unity调用-so"><a href="#3-3-Unity调用-so" class="headerlink" title="3.3 Unity调用.so"></a>3.3 Unity调用.so</h2><p>使用<code>nm -D libNativeCode.so</code> 来查看so中是否包含了写好的方法：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555068534.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555068534.png" alt="Image 0011555068534.png"></a></p>
<p>将.so拖入Assets-Plugins-Android文件夹。在属性面板修改库的相关设置：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555136600.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555136600.png" alt="Image 0011555136600.png"></a></p>
<p>然后新建C#脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">using UnityEngine;</span><br><span class="line">using System.Collections;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line">public class CallNativeCode : MonoBehaviour &#123;</span><br><span class="line"></span><br><span class="line">  [DllImport(&quot;native&quot;)]</span><br><span class="line">  private static extern int NoArgReturnSth();</span><br><span class="line"> </span><br><span class="line">    int i = NoArgReturnSth();</span><br><span class="line">    void OnGUI ()</span><br><span class="line">  &#123;</span><br><span class="line">    float x = 3;</span><br><span class="line">    float y = 10;</span><br><span class="line">    //GUI.Label (new Rect (15, 125, 450, 100), &quot;adding &quot; + x  + &quot; and &quot; + y + &quot; in native code equals &quot; + add(x,y));</span><br><span class="line">        GUI.Label(new Rect(15, 225, 450, 100), i.ToString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拖拽到任意物体，这是Unity会报错：DllNotFoundException: native，此时不用理会，因为.so文件无论如何也无法在windows环境下调用。所以需要打包成apk在模拟器上运行，发布设置按图片中的对应即可：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555136869.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555136869.png" alt="Image 0011555136869.png"></a></p>
<p>安装APK运行，这时可以看到c#从.so调用了方法并返回了一个值：</p>
<p><a href="http://img.dongbeigtl.top/A文章需要的截图/CSharp调用C动态链接库DLL/Image 0011555136994.png" target="_blank" rel="noopener"><img src="http://img.dongbeigtl.top/A%E6%96%87%E7%AB%A0%E9%9C%80%E8%A6%81%E7%9A%84%E6%88%AA%E5%9B%BE/CSharp%E8%B0%83%E7%94%A8C%E5%8A%A8%E6%80%81%E9%93%BE%E6%8E%A5%E5%BA%93DLL/Image%200011555136994.png" alt="Image 0011555136994.png"></a></p>
<p><strong>需要注意的几点：</strong></p>
<ul>
<li>[DllImport(“filename”)]，filename不要写lib前缀以及.so后缀，如例子中生成的.so叫libnative.so，DllImport引入时只需写native。（强制规定）</li>
<li>如果在模拟器中依然出现DllNotFoundException异常，会有几种情况： 1.发布APK时对应的.so库位数不一致；2.DllImport没有找到.so库；3.找到了.so库但是没有找到对应的方法。</li>
<li>Win32Exception提示apksigner.bat找不到，我的SDK最高API是26，但是26的文件夹下没有apksigner.bat。临时的解决办法是删除26版本。（把文件夹删除）</li>
<li>CommandInvokationFailure: Gradle build failed。解决办法：Unity编辑器 File-&gt;Build Setting-&gt;Android-&gt;Build System选择Internal</li>
</ul>
<h1 id="四-多平台适应"><a href="#四-多平台适应" class="headerlink" title="四 多平台适应"></a>四 多平台适应</h1><hr>
<p>打包出Android在模拟器运行太麻烦，可以通过配置多平台的链接库实现平台自适应。首先准备好各平台的链接库，然后在</p>
<p>File-&gt;Build Settings-Switch Platform进行平台转换。</p>
<p>适配代码如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">using System.Collections;</span><br><span class="line">using System.Collections.Generic;</span><br><span class="line">using UnityEngine;</span><br><span class="line">using System.Runtime.InteropServices;</span><br><span class="line"></span><br><span class="line">public class NewBehaviourScript : MonoBehaviour &#123;</span><br><span class="line">#if UNITY_STANDALONE_WIN</span><br><span class="line">    const string fcuk = &quot;CFunction&quot;;</span><br><span class="line">#else</span><br><span class="line">    const string fcuk = &quot;native&quot;;</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">    [DllImport(fcuk)]</span><br><span class="line">    private static extern int NoArgReturnSth();</span><br><span class="line"></span><br><span class="line">    void OnGUI()</span><br><span class="line">    &#123;</span><br><span class="line">        int i = NoArgReturnSth();</span><br><span class="line">        GUI.Button(new Rect(1, 1, 200, 100), i.ToString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="五-备注"><a href="#五-备注" class="headerlink" title="五 备注"></a>五 备注</h1><p>文档中没有写关于如何生成静态库的方法，但其实和生成动态库是一样的只是参数不同。</p>
<p>生成Android可以使用的.so文件的方法不止文中写的这些，但需要注意的是有些方法生产的so库只能在Linux下使用，如利用VisualGDB和Linux虚拟机交叉编译生成的.so库（<a href="https://visualgdb.com/tutorials/linux/libraries/" target="_blank" rel="noopener">使用Visual Studio创建Linux库</a>），以及在windows环境下利用gcc编译出obj再转化为.so库的方法。</p>
<p>C++的链接库生成，和语法以及一些细微的差别在文中没有介绍。</p>
<p>.dll和.so的方法参数以及传参各有不同，具体区别下篇文档再做说明。可以先看看：</p>
<ol>
<li><a href="https://yq.aliyun.com/articles/678154" target="_blank" rel="noopener">C#调用C/C++ DLL 参数传递和回调函数的总结</a></li>
<li><a href="https://www.cnblogs.com/stemon/p/4515522.html" target="_blank" rel="noopener">C#调用C/C++动态库 封送结构体，结构体数组</a></li>
</ol>
<p>文中部分资料摘自：</p>
<ul>
<li>微软官方资料：<a href="https://docs.microsoft.com/zh-cn/cpp/build/walkthrough-creating-and-using-a-dynamic-link-library-cpp?view=vs-2019" target="_blank" rel="noopener">创建和使用你自己动态链接库 （c + +）</a></li>
<li>C语言中文网：<a href="http://c.biancheng.net/view/228.html" target="_blank" rel="noopener"> C中函数指针简介及其用法</a></li>
<li>阿里云社区：<a href="https://yq.aliyun.com/articles/678154" target="_blank" rel="noopener">C#调用C/C++ DLL 参数传递和回调函数的总结</a></li>
<li><a href="https://www.cnblogs.com/stemon/p/4515522.html" target="_blank" rel="noopener">C#调用C/C++动态库 封送结构体，结构体数组</a></li>
<li><a href="https://blog.csdn.net/imfengyitong/article/details/51549010" target="_blank" rel="noopener">C#调用C函数(DLL)传递参数问题</a></li>
<li><a href="https://blog.csdn.net/sdl2005lyx/article/details/6796037" target="_blank" rel="noopener">平台调用P-INVOKE(一)–(基础篇)</a></li>
<li><a href="https://www.cnblogs.com/cg88/p/9143866.html" target="_blank" rel="noopener">CallingConvention理解</a></li>
<li><a href="https://blog.csdn.net/yapingxin/article/details/7288325" target="_blank" rel="noopener">［科普小短文］在C#中调用C语言函数</a></li>
<li><a href="https://blog.csdn.net/yapingxin/article/details/7288164" target="_blank" rel="noopener">Visual C++ 2010 Express Tips: 用 C 和 C++ 创建动态链接库</a></li>
<li><a href="https://blog.csdn.net/bad_boy627056049/article/details/73658073" target="_blank" rel="noopener">动态库和静态库的区别</a></li>
<li><a href="https://blog.csdn.net/qq21497936/article/details/83825098" target="_blank" rel="noopener">VS2017编写纯C库以及使用C#调用C库方法</a></li>
<li><a href="https://www.cnblogs.com/EltonLiang/p/7392410.html" target="_blank" rel="noopener">VS2015_动态链接库学习</a></li>
<li><a href="https://blog.csdn.net/leo9150285/article/details/8804705" target="_blank" rel="noopener">用VS2010将C程序做成动态链接库dll</a></li>
<li><a href="https://blog.csdn.net/zt_xcyk/article/details/78006223" target="_blank" rel="noopener">VS2015设置DLL和LIB的输出目录</a></li>
<li>Android中IDE、ADT、SDK、JDK、NDK的含义解释</li>
<li><a href="https://blog.csdn.net/afei__/article/details/81272251" target="_blank" rel="noopener">ABI： abiFilters 详解</a></li>
<li><a href="https://www.cnblogs.com/scotth/p/3977928.html" target="_blank" rel="noopener">介绍linux/windows OS下静态库（.a、.lib）和动态库（.so、.dll）的 link &amp; load</a></li>
</ul>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/CSharp/" rel="tag"># CSharp</a>
          
            <a href="/tags/Unity/" rel="tag"># Unity</a>
          
            <a href="/tags/C/" rel="tag"># C</a>
          
            <a href="/tags/Android/" rel="tag"># Android</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/12/11/CSharp笔记/" rel="next" title="CSharp笔记">
                <i class="fa fa-chevron-left"></i> CSharp笔记
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/12/11/C和Lua交互/" rel="prev" title="LuaInterface简介">
                LuaInterface简介 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>

 
  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/myselelogin.png" alt="Sayi">
            
              <p class="site-author-name" itemprop="name">Sayi</p>
              <div class="site-description motion-element" itemprop="description">Just noob.</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                    <span class="site-state-item-count">1</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">11</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/qihr" title="GitHub &rarr; https://github.com/qihr" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:qhr.geek@gmail.com" title="E-Mail &rarr; mailto:qhr.geek@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
            </div>
          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#一-概述"><span class="nav-text">一 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-动态与静态链接库"><span class="nav-text">1.1 动态与静态链接库</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#区别"><span class="nav-text">区别</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-不同系统下的链接库格式"><span class="nav-text">1.2 不同系统下的链接库格式</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-3-P-Invoke"><span class="nav-text">1.3 P/Invoke</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-4-MinGW和Cygwin"><span class="nav-text">1.4 MinGW和Cygwin</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#二-Windows下的链接库调用"><span class="nav-text">二 Windows下的链接库调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-0-准备环境"><span class="nav-text">2.0 准备环境</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-DLL项目"><span class="nav-text">2.1 DLL项目</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-1建立DLL项目"><span class="nav-text">2.1.1建立DLL项目</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-2文件介绍"><span class="nav-text">2.1.2文件介绍</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-3-将DLL项目修改为C"><span class="nav-text">2.1.3 将DLL项目修改为C</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-4-编写C代码"><span class="nav-text">2.1.4 编写C代码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-5-导出DLL"><span class="nav-text">2.1.5 导出DLL</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-C-调用DLL库（简单的控制台Demo）"><span class="nav-text">2.2 C#调用DLL库（简单的控制台Demo）</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3在Unity下使用DLL"><span class="nav-text">2.3在Unity下使用DLL</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异常信息"><span class="nav-text">异常信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#三-Android下的链接库调用"><span class="nav-text">三 Android下的链接库调用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-通过NDK生成-so文件"><span class="nav-text">3.1 通过NDK生成.so文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-1-准备环境"><span class="nav-text">3.1.1 准备环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-2-配置文件"><span class="nav-text">3.1.2 配置文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-3-编译"><span class="nav-text">3.1.3 编译</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-通过Cmake生成-so文件"><span class="nav-text">3.2 通过Cmake生成.so文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-1-准备环境"><span class="nav-text">3.2.1 准备环境</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-使用Android-Studio生成-so"><span class="nav-text">3.3 使用Android Studio生成.so</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-1-准备环境"><span class="nav-text">3.3.1 准备环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-2-项目配置"><span class="nav-text">3.3.2 项目配置</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-Unity调用-so"><span class="nav-text">3.3 Unity调用.so</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#四-多平台适应"><span class="nav-text">四 多平台适应</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#五-备注"><span class="nav-text">五 备注</span></a></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Sayi</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">121k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">1:50</span>
  
</div>








        








        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/utils.js?v=7.1.0"></script>

  <script src="/js/motion.js?v=7.1.0"></script>



  
  


  <script src="/js/schemes/muse.js?v=7.1.0"></script>




  
  <script src="/js/scrollspy.js?v=7.1.0"></script>
<script src="/js/post-details.js?v=7.1.0"></script>



  


  <script src="/js/next-boot.js?v=7.1.0"></script>


  

  

  

  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
